<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Impec: Smile Challenge</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
    .gradient-bg { background-image: linear-gradient(to bottom right, #f8bbd0, #e91e63); }
    canvas { width: 100%; height: 100%; display: block; }
  </style>

  <!-- MediaPipe FaceMesh -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4">

  <!-- Main Container -->
  <div class="bg-white rounded-3xl shadow-xl w-full max-w-md p-6 sm:p-8 space-y-6 text-center">

    <!-- Header -->
    <div class="flex flex-col items-center space-y-4">
      <img src="assets/mid-logo.png" alt="Impec Logo" class="w-24 h-24 rounded-full shadow">
      <h1 class="text-3xl sm:text-4xl font-bold">Impec: Smile Challenge</h1>
      <p class="text-gray-500 text-sm sm:text-base">Upload a photo, check your smile score, and unlock a discount on aligners.</p>
    </div>

    <!-- Upload Section -->
    <div class="space-y-4">
      <input type="file" id="upload-btn" accept="image/*"
             class="w-full border border-gray-300 rounded-lg px-4 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-pink-400">
      <div class="text-gray-400 text-sm">Tip: Use a well-lit photo with your full smile visible.</div>
    </div>

    <!-- Results Section -->
    <div id="results-section" class="space-y-6 hidden">
      <div class="flex flex-col items-center space-y-2">
        <span class="text-green-500 font-bold text-lg">Analysis Complete!</span>
        <h2 class="text-3xl font-bold">Your Smile Score</h2>
        <div class="text-6xl font-extrabold text-pink-600" id="smile-score-display">--%</div>
      </div>

      <div id="results-image-container" class="relative w-full h-48 rounded-xl overflow-hidden shadow-md bg-gray-100">
        <img id="results-image" class="absolute inset-0 w-full h-full object-contain" />
        <canvas id="results-canvas" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>
      </div>

      <div class="flex items-center justify-between p-4 bg-yellow-100 rounded-xl shadow-inner">
        <span class="font-semibold text-lg text-yellow-800">Your Discount:</span>
        <span id="discount-percent" class="text-3xl font-extrabold text-[#e91e63]">0%</span>
      </div>

      <!-- Download Button -->
      <button id="download-result-btn"
              class="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-full shadow-lg hover:bg-green-600 transition-colors duration-300">
        Download Result
      </button>

      <p class="text-center text-gray-600 font-medium">
        To get a detailed review of your smile and find the perfect correction procedure, click below and share your result with our expert.
      </p>

      <a id="whatsapp-link" href="#" target="_blank"
         class="inline-block w-full gradient-bg text-white font-bold py-3 px-6 rounded-full shadow-lg transition-colors duration-300 text-center">
        Chat with Expert
      </a>
    </div>
  </div>

<script>
const uploadBtn = document.getElementById('upload-btn');
const resultsSection = document.getElementById('results-section');
const resultsImage = document.getElementById('results-image');
const resultsCanvas = document.getElementById('results-canvas');
const smileScoreDisplay = document.getElementById('smile-score-display');
const discountDisplay = document.getElementById('discount-percent');
const downloadBtn = document.getElementById('download-result-btn');
const ctx = resultsCanvas.getContext('2d');

const resultCache = {}; // cache by image hash
const faceMesh = new FaceMesh({ locateFile: (file) => 
  `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}` 
});
faceMesh.setOptions({
  maxNumFaces: 1,
  refineLandmarks: true,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7
});

uploadBtn.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const hash = await hashImage(file);
  if (resultCache[hash]) {
    displayResult(resultCache[hash]);
    return;
  }

  const img = await loadImage(URL.createObjectURL(file));
  resultsImage.src = img.src;
  resultsCanvas.width = img.width;
  resultsCanvas.height = img.height;
  ctx.clearRect(0, 0, resultsCanvas.width, resultsCanvas.height);

  faceMesh.onResults((results) => {
    if (!results.multiFaceLandmarks.length) {
      alert("No face detected. Please try again with a clear photo.");
      return;
    }
    const landmarks = results.multiFaceLandmarks[0];
    const teethMask = detectTeethMask(img, landmarks);
    drawOverlay(teethMask);
    const smileScore = computeSmileScore(teethMask);
    const discount = getDiscount(smileScore);
    const result = { img, smileScore, discount, teethMask };
    resultCache[hash] = result;
    displayResult(result);
  });

  await faceMesh.send({ image: img });
});

downloadBtn.addEventListener('click', () => {
  const downloadCanvas = document.createElement('canvas');
  downloadCanvas.width = resultsCanvas.width;
  downloadCanvas.height = resultsCanvas.height + 120;
  const dctx = downloadCanvas.getContext('2d');

  dctx.drawImage(resultsImage, 0, 0, resultsCanvas.width, resultsCanvas.height);
  dctx.drawImage(resultsCanvas, 0, 0);

  const logo = new Image();
  logo.src = "assets/mid-logo.png";
  logo.onload = () => {
    dctx.drawImage(logo, 20, resultsCanvas.height + 10, 80, 80);
    dctx.fillStyle = "#111";
    dctx.font = "bold 32px Inter";
    dctx.fillText(`Smile Score: ${smileScoreDisplay.textContent}`, 120, resultsCanvas.height + 50);
    dctx.fillStyle = "#e91e63";
    dctx.fillText(`Discount: ${discountDisplay.textContent}`, 120, resultsCanvas.height + 100);

    const a = document.createElement('a');
    a.href = downloadCanvas.toDataURL("image/png");
    a.download = `smile-result-${Date.now()}.png`;
    a.click();
  };
});

async function hashImage(file) {
  const buffer = await file.arrayBuffer();
  const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
  return Array.from(new Uint8Array(hashBuffer))
    .map(b => b.toString(16).padStart(2, '0'))
    .join('');
}

function loadImage(src) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.src = src;
  });
}

// ðŸ”¥ Enhanced Teeth Detection with Lip Masking
function detectTeethMask(img, landmarks) {
  const offCanvas = document.createElement('canvas');
  offCanvas.width = img.width;
  offCanvas.height = img.height;
  const offCtx = offCanvas.getContext('2d');
  offCtx.drawImage(img, 0, 0);
  const imageData = offCtx.getImageData(0, 0, img.width, img.height);
  const mask = new Uint8ClampedArray(imageData.width * imageData.height);

  // Create lip polygon
  const lipIndices = [...Array(28).keys()].map(i => i + 61); // mediapipe lips 61â€“88
  const path = new Path2D();
  path.moveTo(landmarks[lipIndices[0]].x * img.width, landmarks[lipIndices[0]].y * img.height);
  lipIndices.forEach(idx => {
    const pt = landmarks[idx];
    path.lineTo(pt.x * img.width, pt.y * img.height);
  });
  path.closePath();

  // Iterate pixels, include only those inside lips polygon
  const tmpCtx = document.createElement('canvas').getContext('2d');
  tmpCtx.canvas.width = img.width;
  tmpCtx.canvas.height = img.height;
  tmpCtx.fillStyle = "#000";
  tmpCtx.fill(path);

  const lipMask = tmpCtx.getImageData(0, 0, img.width, img.height).data;
  for (let i = 0; i < imageData.data.length; i += 4) {
    const insideLip = lipMask[i + 3] > 0; // alpha channel from fill
    if (!insideLip) continue;
    const r = imageData.data[i];
    const g = imageData.data[i + 1];
    const b = imageData.data[i + 2];
    const brightness = (r + g + b) / 3;
    mask[i / 4] = brightness > 180 ? 255 : 0;
  }
  return { mask, width: img.width, height: img.height };
}

function drawOverlay(teethMask) {
  const imageData = ctx.createImageData(teethMask.width, teethMask.height);
  for (let i = 0; i < teethMask.mask.length; i++) {
    if (teethMask.mask[i] === 255) {
      imageData.data[i * 4] = 255;
      imageData.data[i * 4 + 1] = 255;
      imageData.data[i * 4 + 2] = 255;
      imageData.data[i * 4 + 3] = 120;
    }
  }
  ctx.putImageData(imageData, 0, 0);
}

function computeSmileScore(teethMask) {
  const visibleTeeth = teethMask.mask.reduce((a, v) => a + (v === 255 ? 1 : 0), 0);
  const coverage = visibleTeeth / teethMask.mask.length;
  let score = Math.min(100, Math.max(0, coverage * 300));
  return Math.round(score);
}

function getDiscount(smileScore) {
  const Dmin = 10;
  const Dmax = 30;
  return +(Dmax - (smileScore / 100) * (Dmax - Dmin)).toFixed(2);
}

function displayResult({ smileScore, discount }) {
  resultsSection.classList.remove('hidden');
  smileScoreDisplay.textContent = `${smileScore}%`;
  discountDisplay.textContent = `${discount}%`;
}
</script>
</body>
</html>
